## Ведение журнала изменений БД

В качестве системы управления версиями БД используем инструмент [Liquibase](https://www.liquibase.org/documentation/databasechangelog.html).

## Соглашение по ведению файлов журнала изменений БД

### Структура главного журнала изменений

    liquibase/changelog
    ├──changelog.xml                                    (1) главный журнал изменений
    ├──v<MAJOR>.<MINOR>                                 (2) каталог изменений для версии
       ├──changelog-v<MAJOR>.<MINOR>-cumulative.xml     (3) кумулятивный файл изменений версии
       ├──yyyyMMdd-NN-M-<название>.<формат>             (4) файл с изменениями
       ├──...
    ├──...


**(1) Главный журнал изменений**

Включает только кумулятивные файлы чейнджлогов для каждой версии (`<MAJOR>.<MINOR>`).

**(2) Каталог изменений для версии**

Содержит файлы:
- изменений для версии `<MAJOR>.<MINOR>.0`
- изменения-патчи `<MAJOR>.<MINOR>.<PATCH>`
- кумулятивный файл на версию `changelog-v<MAJOR>.<MINOR>-cumulative.xml`

**(3) Кумулятивный файл изменений версии**

Включает все изменения в рамках версии `<MAJOR>.<MINOR>` (только `<include/>`).

**(4) Файл с изменениями**

Содержит конкретные чейнджсеты.

*Соглашение по именованию*

    yyyyMMdd-NN-M-<название>.<формат>
    
    yyyyMMdd   - дата изменения
    NN         - порядковый номер в течение дня, считается от 0
    M          - номер для разрешения конфликтов, по умолчанию 0
    <название> - краткое описание ченджсета, например "add_age_to_user"
    <формат>   - формат файла журнала изменений, например xml или sql

### Общие правила создания файла изменений

1. Внутри файла изменений чейнджсеты необходимо именовать:

        <название файла изменений>-<порядковый номер>
    
        Пример: файл изменений 20190101-00-0-add_age_to_user.xml содержит два чейнджсета
                id = 20190101-00-0-add_age_column-0
                id = 20190101-00-0-migrate_age_values-1

2. Для каждого чейнджсета необходимо указывать автора в виде корпоративной почты автора изменений.

3. Изменения DDL необходимо выносить в отдельный чейнджсет внутри файла изменений. Это необходимо из-за того что 
изменения DDL не во всех БД включаются в транзакцию и в случае необходимости миграции придется переписывать чейнджлоги 
чтобы избежать потенциальных проблем.

4. В атрибуте `logicalFilePath` для `databaseChangeLog` необходимо явно указать путь к файлу относительно главного 
журнала изменений, например `v1.0/20190101-00-0-add_age_to_user.xml`. Это необходимо для того, чтобы избежать дублирования 
применения изменений при исполнении команд liquibase из разных директорий

5. Допускается ведение журнала изменений как в xml, так и в sql файлах.